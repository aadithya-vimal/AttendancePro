<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Pro</title>
    <link rel="icon" type="image/x-icon" href="AttendanceApplication.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK Scripts -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // IMPORTANT: Your web app's Firebase configuration
      // This object will be provided by your environment. In a real project, you'd get this from your Firebase project settings.
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- This is our main application logic, wrapped to ensure Firebase is ready ---
      async function main() {
        // Sign in the user anonymously for this demonstration.
        // In a real app, this would use the Google Sign-In credentials.
        await signInAnonymously(auth);
        const user = auth.currentUser;

        if (user) {
            const userId = user.uid;
            // Create a reference to the user's specific document in Firestore
            const userDocRef = doc(db, "users", userId);

            // --- Set up a real-time listener for the user's data ---
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // When data changes in the database, update our local variables and re-render the UI
                    window.appState.subjects = data.subjects || [];
                    window.appState.attendanceData = data.attendanceData || {};
                } else {
                    // If the user is new and has no document, initialize with default data
                    const defaultData = {
                        subjects: [
                            "FRONT END UI/UX DEVELOPMENT", "DIGITAL SYSTEMS AND COMPUTER ARCHITECTURE", "DISCRETE MATHEMATICS", 
                            "HOLISTIC EDUCATION DEVELOPMENT II", "DATA STRUCTURES", "ENTREPRENEURSHIP AND IPR", 
                            "OBJECT ORIENTED PROGRAMMING", "HONOURS/MINORS", "PYTHON PROGRAMMING", "ABILITY ENHANCEMENT COURSE III"
                        ],
                        attendanceData: {}
                    };
                    setDoc(userDocRef, defaultData); // Save this default data to their new document
                    window.appState.subjects = defaultData.subjects;
                    window.appState.attendanceData = defaultData.attendanceData;
                }
                // Re-render the entire UI whenever data changes
                window.appState.renderAll();
            });

            // Make the user document reference globally available for saving data
            window.appState.userDocRef = userDocRef;
        }
      }

      main();
    </script>

    <style>
        /* Your existing styles remain unchanged */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #121212, #1a1a2e); }
        .card-hover { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .card-hover:hover { transform: translateY(-8px) scale(1.02); }
        .progress-bar { height: 6px; border-radius: 3px; background-color: rgba(255, 255, 255, 0.1); }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .subject-selector { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .subject-selector:hover { background-color: rgba(255, 255, 255, 0.08); transform: translateX(4px); }
        .subject-selector.selected { background-color: rgba(255, 255, 255, 0.12); border-left: 4px solid #4f46e5; transform: translateX(4px); }
        #subjectsList::-webkit-scrollbar { width: 6px; }
        #subjectsList::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        #subjectsList::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); }
        .result-card { animation: cardEnter 0.6s cubic-bezier(0.22, 1, 0.36, 1) both; }
        @keyframes cardEnter { 0% { opacity: 0; transform: translateY(20px) scale(0.98); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .glow { animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(255, 255, 255, 0.1); } to { box-shadow: 0 0 20px rgba(255, 255, 255, 0.3); } }
        .text-gradient { background: linear-gradient(90deg, #a5b4fc, #818cf8); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .mode-button.active { background-color: rgba(79, 70, 229, 0.5); transform: translateY(-4px) scale(1.01); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">

    <!-- Fixed Logout Button -->
    <button onclick="window.appState.logout()" title="Logout" class="fixed top-6 right-6 z-50 bg-red-500 hover:bg-red-600 text-white p-3 rounded-full transition-all transform hover:scale-110 shadow-lg">
        <i class="fas fa-sign-out-alt"></i>
    </button>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <div class="inline-block mb-6"><div class="bg-white/5 backdrop-blur-lg rounded-full p-4 shadow-lg glow"><i class="fas fa-calendar-check text-3xl text-gradient"></i></div></div>
            <h1 class="text-5xl md:text-6xl font-bold mb-4 text-gradient">Attendance Pro</h1>
            <p class="text-xl opacity-90 max-w-2xl mx-auto">Precision tracking for academic excellence. Calculate, optimize, and maintain your perfect attendance.</p>
        </header>

        <!-- Attendance Overview Section -->
        <div class="mb-10">
            <h2 class="text-3xl font-bold mb-6 text-center">Attendance Overview</h2>
            <div id="attendanceOverview" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
        </div>

        <!-- Main App Container -->
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Panel - Subjects List -->
            <div class="lg:w-1/4 bg-white/10 backdrop-blur-sm rounded-xl p-6 shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Your Subjects</h2>
                    <button onclick="window.appState.openEditWindow()" title="Edit Subjects" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full transition-transform hover:scale-110"><i class="fas fa-edit"></i></button>
                </div>
                <div class="space-y-2 max-h-[calc(100vh-200px)] overflow-y-auto pr-2" id="subjectsList"></div>
            </div>

            <!-- Right Panel - Main Content -->
            <div class="lg:w-3/4 bg-white/10 backdrop-blur-sm rounded-xl p-6 shadow-lg">
                <!-- Mode Selection -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4">Select Calculation Type</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="mode-attend-single" onclick="window.appState.setMode('attend-single')" class="mode-button card-hover bg-white/10 hover:bg-white/20 rounded-lg p-4 text-left transition-all"><i class="fas fa-user-graduate text-2xl mb-2 text-indigo-300"></i><h3 class="font-bold text-lg">Selected Subjects Attendance</h3><p class="text-sm opacity-80">Calculate how many more classes you need to attend</p></button>
                        <button id="mode-attend-all" onclick="window.appState.setMode('attend-all')" class="mode-button card-hover bg-white/10 hover:bg-white/20 rounded-lg p-4 text-left transition-all"><i class="fas fa-users text-2xl mb-2 text-indigo-300"></i><h3 class="font-bold text-lg">All Subjects Attendance</h3><p class="text-sm opacity-80">Calculate total classes needed across all subjects</p></button>
                        <button id="mode-bunk-single" onclick="window.appState.setMode('bunk-single')" class="mode-button card-hover bg-white/10 hover:bg-white/20 rounded-lg p-4 text-left transition-all"><i class="fas fa-bed text-2xl mb-2 text-blue-300"></i><h3 class="font-bold text-lg">Selected Subjects Bunk</h3><p class="text-sm opacity-80">Calculate how many classes you can safely bunk</p></button>
                        <button id="mode-bunk-all" onclick="window.appState.setMode('bunk-all')" class="mode-button card-hover bg-white/10 hover:bg-white/20 rounded-lg p-4 text-left transition-all"><i class="fas fa-couch text-2xl mb-2 text-blue-300"></i><h3 class="font-bold text-lg">All Subjects Bunk</h3><p class="text-sm opacity-80">Calculate bunkable classes across all subjects</p></button>
                    </div>
                </div>
                <!-- Input Form & Results -->
                <div id="inputForm" class="mb-8"></div>
                <div id="resultsContainer" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">Results</h2>
                    <div id="resultsContent" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // We wrap our entire application logic in a global object
        // to avoid polluting the global namespace and to make data management cleaner.
        window.appState = {
            subjects: [],
            attendanceData: {},
            currentMode: '',
            selectedSubjects: [],
            userDocRef: null, // This will hold the reference to the user's Firestore document

            // --- DATA PERSISTENCE ---
            // This function now saves the entire state to Firestore
            async saveData() {
                if (this.userDocRef) {
                    try {
                        await setDoc(this.userDocRef, {
                            subjects: this.subjects,
                            attendanceData: this.attendanceData
                        });
                    } catch (error) {
                        console.error("Error saving data to Firestore: ", error);
                    }
                }
            },
            
            getSubjectData(index) {
                if (!this.attendanceData[index]) {
                    this.attendanceData[index] = { attended: '', total: '', requiredPerc: 75 };
                }
                return this.attendanceData[index];
            },

            updateSubjectDataFromInput(e) {
                const { index, field } = e.target.dataset;
                const value = e.target.value;
                const data = this.getSubjectData(index);
                data[field] = value === '' ? '' : parseFloat(value);
                this.saveData(); // Save to Firestore on change
            },

            logout() {
                // For a real app with auth, you would sign out here.
                // For this demo, we'll just clear the flag and redirect.
                localStorage.removeItem('loggedIn');
                window.location.href = './login.html';
            },

            // --- RENDER FUNCTIONS ---
            renderAll() {
                this.renderSubjectsList();
                this.renderAttendanceOverview();
                this.renderInputForm();
            },
            
            renderAttendanceOverview() { /* ... same as before ... */ },
            renderSubjectsList() { /* ... same as before ... */ },
            renderInputForm() { /* ... same as before ... */ },
            showResults(content) { /* ... same as before ... */ },

            // --- EVENT HANDLERS & LOGIC ---
            setMode(mode) { /* ... same as before ... */ },
            selectSubject(index) { /* ... same as before ... */ },
            calculate() { /* ... same as before ... */ },
            clearInputs() {
                const subjectsToClear = this.currentMode.includes('all') ? this.subjects.map((_, i) => i) : this.selectedSubjects;
                subjectsToClear.forEach(index => {
                    this.attendanceData[index] = { attended: '', total: '', requiredPerc: 75 };
                });
                this.saveData(); // Save the cleared data
                document.getElementById('resultsContainer').classList.add('hidden');
            },

            // --- SUBJECT MANAGEMENT (MODAL) ---
            openEditWindow() { /* ... same as before ... */ },
            addNewSubject() { /* ... same as before ... */ },
            saveSubjectChanges(button) {
                const inputs = document.querySelectorAll('.edit-subject-input');
                const newSubjects = [];
                inputs.forEach(input => {
                    const name = input.value.trim();
                    if (name) newSubjects.push(name);
                });
                
                this.subjects = newSubjects;
                this.selectedSubjects = [];
                this.attendanceData = {};
                this.saveData(); // Save the new subjects list and cleared data
                
                button.closest('.fixed').remove();
            }
        };

        // --- Re-implementing rendering functions within the appState object ---
        // (These functions are copied from the previous version but now use `this` to refer to appState)
        
        window.appState.renderAttendanceOverview = function() {
            const container = document.getElementById('attendanceOverview');
            container.innerHTML = '';
            if (this.subjects.length === 0) {
                container.innerHTML = `<p class="text-center text-white/60 col-span-full">No subjects found.</p>`;
                return;
            }
            this.subjects.forEach((subject, index) => {
                const data = this.getSubjectData(index);
                const { attended, total } = data;
                let percentage = (attended && total) ? (attended / total) * 100 : NaN;
                let colorClass = isNaN(percentage) ? 'text-gray-400' : (percentage < 75 ? 'text-red-400' : (percentage < 85 ? 'text-yellow-400' : 'text-green-400'));
                const radius = 30;
                const circumference = 2 * Math.PI * radius;
                const offset = isNaN(percentage) ? circumference : circumference - (percentage / 100) * circumference;
                container.innerHTML += `
                    <div class="bg-white/10 p-4 rounded-xl flex flex-col items-center justify-center text-center">
                        <div class="relative w-20 h-20 mb-2">
                            <svg class="w-full h-full" viewBox="0 0 80 80">
                                <circle class="text-white/10" stroke-width="8" stroke="currentColor" fill="transparent" r="${radius}" cx="40" cy="40" />
                                <circle class="${colorClass} transition-all" stroke-width="8" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="40" cy="40" transform="rotate(-90 40 40)"/>
                            </svg>
                            <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 font-bold text-lg ${colorClass}">${isNaN(percentage) ? '--' : Math.floor(percentage) + '%'}</span>
                        </div>
                        <p class="text-sm font-medium h-10 leading-tight">${subject}</p>
                    </div>`;
            });
        };

        window.appState.renderSubjectsList = function() {
            const container = document.getElementById('subjectsList');
            container.innerHTML = '';
            if (this.subjects.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-white/60"><i class="fas fa-book-open text-3xl mb-3"></i><p>No subjects added yet!</p></div>`;
                return;
            }
            this.subjects.forEach((subject, index) => {
                const div = document.createElement('div');
                div.className = `subject-selector p-3 rounded-lg cursor-pointer ${this.selectedSubjects.includes(index) ? 'selected' : ''}`;
                div.innerHTML = `<div class="flex items-center"><div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center mr-3 flex-shrink-0">${index + 1}</div><div class="truncate text-sm">${subject}</div></div>`;
                div.onclick = () => this.selectSubject(index);
                container.appendChild(div);
            });
        };
        
        // ... (The rest of the app logic would be similarly placed inside the appState object)
        // For brevity, only the modified functions are shown, the rest of the logic
        // for calculation, rendering forms, etc., remains the same but should be
        // part of the window.appState object.

    </script>
</body>
</html>

